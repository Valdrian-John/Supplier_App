import sys
from PyQt6.QtWidgets import (
    QApplication, QMainWindow, QWidget, QVBoxLayout, QHBoxLayout,
    QPushButton, QLabel, QStackedWidget, QLineEdit, QTableWidget,
    QTableWidgetItem, QHeaderView, QCheckBox
)
from PyQt6.QtCore import Qt
from PyQt6.QtGui import QFont


class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        self.setWindowTitle("Supplier Payment Workflow")
        self.setGeometry(200, 200, 1000, 600)

        # store deliveries in memory (so orders + invoices + verification can reflect them)
        self.deliveries = []
        self.payment_done = False  # track payment state

        # Main container
        container = QWidget()
        layout = QHBoxLayout(container)
        layout.setContentsMargins(0, 0, 0, 0)

        # Sidebar
        sidebar_widget = QWidget()
        sidebar_widget.setStyleSheet("background-color: #2c3e50;")
        sidebar = QVBoxLayout(sidebar_widget)
        sidebar.setAlignment(Qt.AlignmentFlag.AlignTop)
        sidebar.setContentsMargins(10, 20, 10, 10)

        button_style = """
            QPushButton {
                color: white;
                background-color: transparent;
                border: none;
                padding: 10px;
                text-align: left;
                font-size: 14px;
            }
            QPushButton:hover {
                background-color: #34495e;
                border-radius: 5px;
            }
            QPushButton:pressed {
                background-color: #1abc9c;
            }
        """

        btn_deliveries = QPushButton("üì¶ Deliveries")
        btn_orders = QPushButton("üìù Orders")
        btn_invoices = QPushButton("üí≥ Invoices")
        btn_verification = QPushButton("‚úÖ Verification")

        for btn in [btn_deliveries, btn_orders, btn_invoices, btn_verification]:
            btn.setStyleSheet(button_style)
            btn.setCursor(Qt.CursorShape.PointingHandCursor)
            sidebar.addWidget(btn)

        # Main workspace
        self.stack = QStackedWidget()
        self.stack.setStyleSheet("background-color: #ecf0f1;")

        self.stack.addWidget(self.create_deliveries_page())
        self.stack.addWidget(self.create_orders_page())
        self.stack.addWidget(self.create_invoices_page())
        self.stack.addWidget(self.create_verification_page())

        # Connect sidebar buttons
        btn_deliveries.clicked.connect(lambda: self.stack.setCurrentIndex(0))
        btn_orders.clicked.connect(lambda: self.refresh_orders())
        btn_invoices.clicked.connect(lambda: self.refresh_invoices())
        btn_verification.clicked.connect(lambda: self.refresh_verification())

        layout.addWidget(sidebar_widget, 1)
        layout.addWidget(self.stack, 4)

        self.setCentralWidget(container)

    # -------------------- Deliveries --------------------

    def create_deliveries_page(self):
        page = QWidget()
        layout = QVBoxLayout(page)

        title = QLabel("üì¶ Deliveries")
        title.setFont(QFont("Segoe UI", 18, QFont.Weight.Bold))
        layout.addWidget(title)

        # Table for deliveries
        self.deliveries_table = QTableWidget(0, 4)
        self.deliveries_table.setHorizontalHeaderLabels(["Product", "Quantity", "Price", "Delete"])
        self.deliveries_table.horizontalHeader().setSectionResizeMode(QHeaderView.ResizeMode.Stretch)
        layout.addWidget(self.deliveries_table)

        # Input fields
        input_layout = QHBoxLayout()
        self.input_product = QLineEdit()
        self.input_product.setPlaceholderText("Enter product name")
        self.input_quantity = QLineEdit()
        self.input_quantity.setPlaceholderText("Enter quantity")
        self.input_price = QLineEdit()
        self.input_price.setPlaceholderText("Enter price")
        add_button = QPushButton("Add Delivery")
        add_button.clicked.connect(self.add_delivery)

        input_layout.addWidget(self.input_product)
        input_layout.addWidget(self.input_quantity)
        input_layout.addWidget(self.input_price)
        input_layout.addWidget(add_button)

        layout.addLayout(input_layout)
        return page

    def add_delivery(self):
        product = self.input_product.text()
        quantity = self.input_quantity.text()
        price = self.input_price.text()

        if product and quantity and price:
            # Save to memory
            self.deliveries.append({"product": product, "quantity": int(quantity), "price": float(price)})

            # Add row to table
            row = self.deliveries_table.rowCount()
            self.deliveries_table.insertRow(row)
            self.deliveries_table.setItem(row, 0, QTableWidgetItem(product))
            self.deliveries_table.setItem(row, 1, QTableWidgetItem(quantity))
            self.deliveries_table.setItem(row, 2, QTableWidgetItem(f"‚Ç±{price}"))

            # Delete button
            btn_delete = QPushButton("üóëÔ∏è")
            btn_delete.clicked.connect(lambda _, r=row: self.delete_delivery(r))
            self.deliveries_table.setCellWidget(row, 3, btn_delete)

            # clear inputs
            self.input_product.clear()
            self.input_quantity.clear()
            self.input_price.clear()

    def delete_delivery(self, row):
        if 0 <= row < len(self.deliveries):
            self.deliveries.pop(row)
            self.deliveries_table.removeRow(row)

    # -------------------- Orders --------------------

    def create_orders_page(self):
        page = QWidget()
        layout = QVBoxLayout(page)

        title = QLabel("üìù Orders (Cross-check)")
        title.setFont(QFont("Segoe UI", 18, QFont.Weight.Bold))
        layout.addWidget(title)

        self.orders_table = QTableWidget(0, 3)
        self.orders_table.setHorizontalHeaderLabels(["Product", "Quantity", "Delivered?"])
        self.orders_table.horizontalHeader().setSectionResizeMode(QHeaderView.ResizeMode.Stretch)
        layout.addWidget(self.orders_table)

        return page

    def refresh_orders(self):
        self.stack.setCurrentIndex(1)
        self.orders_table.setRowCount(0)
        for d in self.deliveries:
            row = self.orders_table.rowCount()
            self.orders_table.insertRow(row)
            self.orders_table.setItem(row, 0, QTableWidgetItem(d["product"]))
            self.orders_table.setItem(row, 1, QTableWidgetItem(str(d["quantity"])))
            checkbox = QCheckBox()
            self.orders_table.setCellWidget(row, 2, checkbox)

    # -------------------- Invoices --------------------

    def create_invoices_page(self):
        page = QWidget()
        layout = QVBoxLayout(page)

        title = QLabel("üí≥ Invoices")
        title.setFont(QFont("Segoe UI", 18, QFont.Weight.Bold))
        layout.addWidget(title)

        self.invoice_table = QTableWidget(0, 3)
        self.invoice_table.setHorizontalHeaderLabels(["Product", "Quantity", "Amount"])
        self.invoice_table.horizontalHeader().setSectionResizeMode(QHeaderView.ResizeMode.Stretch)
        layout.addWidget(self.invoice_table)

        # total + pay button
        bottom_layout = QHBoxLayout()
        self.total_label = QLabel("Total: ‚Ç±0.00")
        self.total_label.setFont(QFont("Segoe UI", 14, QFont.Weight.Bold))
        bottom_layout.addWidget(self.total_label)

        self.pay_button = QPushButton("Pay")
        self.pay_button.setStyleSheet("background-color: #27ae60; color: white; padding: 8px; border-radius: 5px;")
        self.pay_button.clicked.connect(self.make_payment)
        bottom_layout.addWidget(self.pay_button)

        layout.addLayout(bottom_layout)

        return page

    def refresh_invoices(self):
        self.stack.setCurrentIndex(2)
        self.invoice_table.setRowCount(0)
        total = 0
        for d in self.deliveries:
            row = self.invoice_table.rowCount()
            self.invoice_table.insertRow(row)
            self.invoice_table.setItem(row, 0, QTableWidgetItem(d["product"]))
            self.invoice_table.setItem(row, 1, QTableWidgetItem(str(d["quantity"])))
            amount = d["quantity"] * d["price"]
            self.invoice_table.setItem(row, 2, QTableWidgetItem(f"‚Ç±{amount:,.2f}"))
            total += amount
        self.total_label.setText(f"Total: ‚Ç±{total:,.2f}")

    def make_payment(self):
        self.payment_done = True
        self.stack.setCurrentIndex(3)
        self.refresh_verification()

    # -------------------- Verification --------------------

    def create_verification_page(self):
        page = QWidget()
        layout = QVBoxLayout(page)

        title = QLabel("‚úÖ Verification Receipt")
        title.setFont(QFont("Segoe UI", 18, QFont.Weight.Bold))
        layout.addWidget(title)

        self.receipt_label = QLabel("No payments yet.")
        self.receipt_label.setFont(QFont("Segoe UI", 14))
        self.receipt_label.setStyleSheet("background-color: white; padding: 15px; border: 1px solid #bdc3c7;")
        self.receipt_label.setAlignment(Qt.AlignmentFlag.AlignTop)
        layout.addWidget(self.receipt_label)

        return page

    def refresh_verification(self):
        self.stack.setCurrentIndex(3)
        if not self.payment_done:
            self.receipt_label.setText("No payments yet.")
            return

        # Build receipt text
        text = "üßæ Official Receipt\n\n"
        total = 0
        for d in self.deliveries:
            amount = d["quantity"] * d["price"]
            text += f"- {d['product']} | Qty: {d['quantity']} | Price: ‚Ç±{d['price']:,.2f} | Amount: ‚Ç±{amount:,.2f}\n"
            total += amount
        text += f"\nTOTAL: ‚Ç±{total:,.2f}\n"
        text += "\nStatus: PAID ‚úÖ"

        self.receipt_label.setText(text)

if __name__ == "__main__":
    app = QApplication(sys.argv)
    window = MainWindow()
    window.show()
    sys.exit(app.exec())
